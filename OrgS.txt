import tkinter as tk
from tkinter import ttk

# --- Step A: BFG selection ---
def select_bfg_and_filter(df_input):
    root = tk.Tk()
    root.title("Select Business Framework Group")
    root.geometry("480x150")
    root.resizable(False, False)

    bfg_values = sorted([s for s in df_input["Business Framework Group"].dropna().astype(str).str.strip().unique() if s])

    var = tk.StringVar()
    tk.Label(root, text="Business Framework Group:").pack(pady=(12,2))
    combo = ttk.Combobox(root, textvariable=var, values=bfg_values, state="readonly", width=60)
    combo.pack(pady=(0,10))
    if bfg_values:
        combo.current(0)

    selected = {"value": None}
    def on_ok():
        selected["value"] = combo.get()
        root.destroy()

    tk.Button(root, text="OK", command=on_ok).pack()
    root.mainloop()

    chosen = selected["value"]
    if not chosen:
        raise ValueError("No Business Framework Group selected.")

    df_bfg = df_input[df_input["Business Framework Group"].astype(str).str.strip() == chosen].copy()
    return chosen, df_bfg

# --- Step B: Recompute counts ---
def recompute_counts(df_bfg, df_open_enriched):
    direct_counts_actual = (
        df_bfg[df_bfg["Employee ID"].notna()]
        .groupby("Functional Manager Employee ID")["Employee ID"]
        .nunique()
        .to_dict()
    )
    open_pos_counts = (
        df_open_enriched[df_open_enriched["Functional Manager Employee ID"].isin(df_bfg["Employee ID"])]
        .groupby("Functional Manager Employee ID")["PID"]
        .size()
        .to_dict()
    )
    direct_counts_total = {
        mgr: direct_counts_actual.get(mgr, 0) + open_pos_counts.get(mgr, 0)
        for mgr in set(direct_counts_actual) | set(open_pos_counts)
    }
    return direct_counts_actual, open_pos_counts, direct_counts_total

# --- Step C: Coverage summary export ---
def export_bfg_coverage_summary(df_bfg, covered_ids, excel_path="OrgChart_Summary.xlsx"):
    all_ids = set(df_bfg["Employee ID"].dropna())
    uncovered_ids = all_ids - covered_ids

    mds = df_bfg[df_bfg["GCB"] == "MD"]
    l5s = df_bfg[df_bfg["GCB"] == "3"]
    l6s = df_bfg[df_bfg["GCB"] == "4"]

    summary = pd.DataFrame({
        "Metric": ["MD Count", "L5 Count", "L6 Count", "Total Employees", "Covered", "Uncovered"],
        "Value": [len(mds), len(l5s), len(l6s), len(all_ids), len(covered_ids), len(uncovered_ids)]
    })

    covered_df = df_bfg[df_bfg["Employee ID"].isin(covered_ids)].copy()
    exceptions_df = df_bfg[df_bfg["Employee ID"].isin(uncovered_ids)].copy()
    exceptions_df["Reason"] = exceptions_df.apply(
        lambda r: "No manager found" if pd.isna(r.get("Functional Manager Employee ID"))
        else "Not attached to MD/L5 in selected BFG", axis=1
    )

    with pd.ExcelWriter(excel_path) as writer:
        summary.to_excel(writer, sheet_name="Summary", index=False)
        covered_df.to_excel(writer, sheet_name="Covered", index=False)
        exceptions_df.to_excel(writer, sheet_name="Exceptions", index=False)

    print(f"Coverage summary exported to {excel_path}")

# --- Step D: Controller ---
def build_bfg_orgcharts_controller(df_final, df_open_enriched,
                                   draw_orgchart_fn,
                                   export_indented_fn,
                                   summary_excel_path="OrgChart_Summary.xlsx",
                                   ppt_dir=".",
                                   indented_excel_dir="."):
    # 1) BFG selection
    selected_bfg, df_bfg = select_bfg_and_filter(df_final)
    print(f"Selected BFG: {selected_bfg} | Rows: {len(df_bfg)}")

    # 2) Recompute counts
    direct_counts, open_pos_counts, direct_counts_total = recompute_counts(df_bfg, df_open_enriched)

    # 3) Identify MD/L5/L6
    mds = df_bfg[df_bfg["GCB"] == "MD"]["Employee ID"].dropna().unique().tolist()
    l5s = df_bfg[df_bfg["GCB"] == "3"]["Employee ID"].dropna().unique().tolist()
    l6s = df_bfg[df_bfg["GCB"] == "4"]["Employee ID"].dropna().unique().tolist()

    print(f"MDs: {len(mds)} | L5s: {len(l5s)} | L6s: {len(l6s)}")

    covered_ids = set()

    def mark_covered_for_manager(mgr_id):
        covered_ids.add(mgr_id)
        direct_actuals = df_bfg[df_bfg["Functional Manager Employee ID"] == mgr_id]["Employee ID"].dropna().tolist()
        for emp_id in direct_actuals:
            covered_ids.add(emp_id)

    # 4) Generate charts for MDs
    for md_id in mds:
        ppt_path = f"{ppt_dir}/OrgChart_MD_{md_id}.pptx"
        draw_orgchart_fn(md_id, df_bfg, df_open_enriched, direct_counts, open_pos_counts, ppt_path)
        export_indented_fn(md_id, df_bfg, df_open_enriched, direct_counts, open_pos_counts,
                           excel_path=f"{indented_excel_dir}/Indented_MD_{md_id}.xlsx",
                           ppt_path=f"{indented_excel_dir}/Indented_MD_{md_id}.pptx")
        mark_covered_for_manager(md_id)

    # 5) Fill gaps: uncovered L5s with L6 reports
    remaining_l5s = [l5 for l5 in l5s if l5 not in covered_ids]
    for l5_id in remaining_l5s:
        l6_reports = df_bfg[df_bfg["Functional Manager Employee ID"] == l5_id]["Employee ID"].dropna().tolist()
        if len(l6_reports) > 0:
            ppt_path = f"{ppt_dir}/OrgChart_L5_{l5_id}.pptx"
            draw_orgchart_fn(l5_id, df_bfg, df_open_enriched, direct_counts, open_pos_counts, ppt_path)
            export_indented_fn(l5_id, df_bfg, df_open_enriched, direct_counts, open_pos_counts,
                               excel_path=f"{indented_excel_dir}/Indented_L5_{l5_id}.xlsx",
                               ppt_path=f"{indented_excel_dir}/Indented_L5_{l5_id}.pptx")
            mark_covered_for_manager(l5_id)

    # 6) Export coverage summary
    export_bfg_coverage_summary(df_bfg, covered_ids, excel_path=summary_excel_path)

    print("Controller complete: charts generated, coverage tracked, summary exported.")


build_bfg_orgcharts_controller(
    df_final=df_final,
    df_open_enriched=df_open_enriched,
    draw_orgchart_fn=draw_orgchart,
    export_indented_fn=export_indented_text_full,
    summary_excel_path="OrgChart_Summary.xlsx",
    ppt_dir=".",
    indented_excel_dir="."
)
