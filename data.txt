Sub SplitWorkbookByL3()
    Dim wsData As Worksheet, wsL3 As Worksheet, wsL4 As Worksheet, wsOptions As Worksheet
    Dim wbNew As Workbook, wbCurrent As Workbook
    Dim rngL3 As Range, rngL4 As Range
    Dim dict As Object
    Dim L3 As String, L4List As String
    Dim cell As Range, lastRow As Long, lastRowData As Long
    Dim savePath As String
    
    ' Set references
    Set wbCurrent = ThisWorkbook
    Set wsData = wbCurrent.Sheets("Data")
    Set wsL3 = wbCurrent.Sheets("L3 Summary")
    Set wsL4 = wbCurrent.Sheets("L4 Summary")
    Set wsOptions = wbCurrent.Sheets("Options")
    
    ' Define save path (CHANGE THIS)
    savePath = wbCurrent.Path & "\Split Files\"
    If Dir(savePath, vbDirectory) = "" Then MkDir savePath ' Create folder if not exists
    
    ' Get last row of L3 options
    lastRow = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Store L3 & corresponding L4 values in dictionary
    For Each cell In wsOptions.Range("D2:D" & lastRow)
        L3 = cell.Value
        If Not dict.exists(L3) Then
            dict.Add L3, ""
        End If
        dict(L3) = dict(L3) & cell.Offset(0, 1).Value & "," ' Store L4 values
    Next cell
    
    ' Loop through unique L3 values
    For Each L3 In dict.keys
        ' Skip "*"
        If L3 = "*" Then GoTo NextL3
        
        ' Create a new workbook
        wbCurrent.Sheets(Array("Readme", "L3 Summary", "L4 Summary", "Data", "Mapping")).Copy
        Set wbNew = ActiveWorkbook
        
        ' Remove "Reg Summary" sheet
        On Error Resume Next
        Application.DisplayAlerts = False
        wbNew.Sheets("Reg Summary").Delete
        Application.DisplayAlerts = True
        On Error GoTo 0
        
        ' Filter Data Sheet & Delete Unnecessary Rows
        With wbNew.Sheets("Data")
            .AutoFilterMode = False
            lastRowData = .Cells(.Rows.Count, "G").End(xlUp).Row
            
            ' Apply filter on Business Framework Group (Column G)
            .Range("A2:A" & lastRowData).AutoFilter Field:=7, Criteria1:=L3
            
            ' Delete rows that do not match L3
            On Error Resume Next
            .Rows("3:" & lastRowData).SpecialCells(xlCellTypeVisible).Delete
            On Error GoTo 0
            .AutoFilterMode = False
        End With
        
        ' Update L3 Summary sheet's B1 cell
        With wbNew.Sheets("L3 Summary")
            .Range("B1").Value = L3
        End With
        
        ' Update L4 Summary sheet's B1 cell with only relevant L4s
        With wbNew.Sheets("L4 Summary")
            .Range("B1").Value = Left(dict(L3), Len(dict(L3)) - 1) ' Remove last comma
        End With
        
        ' Set Sensitivity Label to Internal
        On Error Resume Next
        wbNew.SensitivityLabelPolicy = "Internal"
        On Error GoTo 0
        
        ' Save the new workbook
        wbNew.SaveAs savePath & L3 & ".xlsx", FileFormat:=xlOpenXMLWorkbook
        wbNew.Close False ' Close new workbook
        
NextL3:
    Next L3
    
    ' Cleanup
    Set dict = Nothing
    MsgBox "Splitting completed!", vbInformation
End Sub
