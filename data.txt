Sub SplitDataByL3()
    Dim wsOptions As Worksheet, wsData As Worksheet, wsL3 As Worksheet, wsL4 As Worksheet
    Dim ws As Worksheet
    Dim L3 As String, L4List As String
    Dim lastRowData As Long, lastRowOptions As Long
    Dim rngL3 As Range, cell As Range
    Dim FilePath As String, NewWorkbook As Workbook
    Dim Sht As Worksheet
    
    ' Disable alerts to prevent interruptions
    Application.DisplayAlerts = False
    Application.ScreenUpdating = False
    
    ' Set worksheet references
    Set wsOptions = ThisWorkbook.Sheets("Options")
    Set wsData = ThisWorkbook.Sheets("Data")
    Set wsL3 = ThisWorkbook.Sheets("L3 Summary")
    Set wsL4 = ThisWorkbook.Sheets("L4 Summary")

    ' Get last row of Options tab (L3 & L4 values)
    lastRowOptions = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row

    ' Get unique L3 values from Options sheet (Column D)
    Set rngL3 = wsOptions.Range("D2:D" & lastRowOptions)

    ' Loop through each unique L3 value
    For Each cell In rngL3.Cells
        L3 = cell.Value
        
        ' Skip empty values
        If L3 <> "" Then
            
            ' Create a new workbook for this L3
            ThisWorkbook.SaveCopyAs ThisWorkbook.Path & "\" & L3 & ".xlsx"
            Set NewWorkbook = Workbooks.Open(ThisWorkbook.Path & "\" & L3 & ".xlsx")
            
            ' Set worksheet references in the new file
            Set wsData = NewWorkbook.Sheets("Data")
            Set wsL3 = NewWorkbook.Sheets("L3 Summary")
            Set wsL4 = NewWorkbook.Sheets("L4 Summary")

            ' Delete "Reg Summary" sheet
            On Error Resume Next
            Set Sht = NewWorkbook.Sheets("Reg Summary")
            If Not Sht Is Nothing Then
                Application.DisplayAlerts = False
                Sht.Delete
                Application.DisplayAlerts = True
            End If
            On Error GoTo 0
            
            ' Get last row of Data sheet
            lastRowData = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
            
            ' Apply filter in Data sheet (Header is in row 2, Data starts from row 3)
            wsData.Range("A2:Z" & lastRowData).AutoFilter Field:=7, Criteria1:=L3
            
            ' Delete rows that do not match L3 (keeping only filtered data)
            wsData.Rows("3:" & lastRowData).SpecialCells(xlCellTypeVisible).Delete
            wsData.AutoFilterMode = False  ' Remove filter after deleting
            
            ' Update L3 Summary B1 cell
            wsL3.Range("B1").Value = L3
            
            ' Collect L4 values corresponding to this L3
            L4List = ""
            For Each c In wsOptions.Range("D2:D" & lastRowOptions).Cells
                If c.Value = L3 Then
                    If L4List = "" Then
                        L4List = c.Offset(0, 1).Value
                    Else
                        L4List = L4List & ", " & c.Offset(0, 1).Value
                    End If
                End If
            Next c
            
            ' Update L4 Summary B1 with corresponding L4 values
            wsL4.Range("B1").Value = L4List
            
            ' Set sensitivity label to Internal
            On Error Resume Next
            NewWorkbook.SensitivityLabelPolicy = "Internal"
            On Error GoTo 0
            
            ' Save and Close
            NewWorkbook.Save
            NewWorkbook.Close False
        End If
    Next cell

    ' Re-enable alerts and screen updating
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    
    MsgBox "Process completed successfully!", vbInformation, "Done"
End Sub
