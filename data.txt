Sub CreateFilteredFiles()
    Dim wsOptions As Worksheet, wsData As Worksheet
    Dim lastRowOptions As Long, rngL3 As Range, cell As Range
    Dim L3Dict As Object, FilePath As String, L3 As Variant
    Dim NewWorkbook As Workbook, wsNewData As Worksheet
    Dim lastRowData As Long
    Dim MainWorkbook As Workbook, NewFilePath As String
    Dim SaveFolder As String
    Dim ws As Worksheet
    
    ' Disable alerts and screen updating
    Application.DisplayAlerts = False
    Application.ScreenUpdating = False
    
    ' Set reference to Options sheet
    Set wsOptions = ThisWorkbook.Sheets("Options")
    
    ' Get last row in column D (L3 values)
    lastRowOptions = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row
    
    ' Create dictionary to store unique L3 values
    Set L3Dict = CreateObject("Scripting.Dictionary")
    
    ' Loop through L3 values and store unique ones
    For Each cell In wsOptions.Range("D2:D" & lastRowOptions)
        If Not L3Dict.Exists(cell.Value) And cell.Value <> "" Then
            L3Dict.Add cell.Value, Nothing
        End If
    Next cell
    
    ' Set folder to save new files
    SaveFolder = ThisWorkbook.Path & "\Filtered_Files\"
    If Dir(SaveFolder, vbDirectory) = "" Then MkDir SaveFolder ' Create folder if not exists
    
    ' Reference the main workbook
    Set MainWorkbook = ThisWorkbook
    
    ' Loop through unique L3 values and create file copies
    For Each L3 In L3Dict.Keys
        ' Define the new file path
        NewFilePath = SaveFolder & L3 & ".xlsx"
        
        ' Create a new workbook and copy sheets
        Set NewWorkbook = Workbooks.Add
        MainWorkbook.Sheets.Copy Before:=NewWorkbook.Sheets(1)
        
        ' Delete any default blank sheets
        For Each ws In NewWorkbook.Sheets
            If ws.Name Like "Sheet*" Then ws.Delete
        Next ws
        
        ' Delete "Reg Summary" sheet if it exists
        On Error Resume Next ' Prevents error if the sheet doesn't exist
        Set ws = NewWorkbook.Sheets("Reg Summary")
        If Not ws Is Nothing Then
            ws.Delete
        End If
        On Error GoTo 0 ' Re-enable error handling
        
        ' Save the workbook in .xlsx format
        NewWorkbook.SaveAs NewFilePath, FileFormat:=xlOpenXMLWorkbook
        NewWorkbook.Close False
    Next L3
    
    ' Re-enable alerts and screen updating
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    
    MsgBox "Files created and 'Reg Summary' deleted successfully!", vbInformation, "Done"
End Sub
