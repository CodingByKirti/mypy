Sub SplitWorkbookByL3()
    Dim wsOptions As Worksheet, wsData As Worksheet, wsL3 As Worksheet, wsL4 As Worksheet
    Dim rngL3 As Range, rngL4 As Range, cell As Range
    Dim dictL4 As Object
    Dim wbNew As Workbook
    Dim lastRow As Long, lastRowData As Long
    Dim L3Value As String, fileName As String
    Dim delRow As Range
    Dim rng As Range
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Set sheet references
    Set wsOptions = ThisWorkbook.Sheets("Options")
    Set wsData = ThisWorkbook.Sheets("Data")
    Set wsL3 = ThisWorkbook.Sheets("L3 Summary")
    Set wsL4 = ThisWorkbook.Sheets("L4 Summary")
    
    ' Find last row in Options tab for L3 values
    lastRow = wsOptions.Cells(wsOptions.Rows.Count, 4).End(xlUp).Row ' Column D
    
    ' Loop through unique L3 values in Options (Column D)
    For Each cell In wsOptions.Range("D2:D" & lastRow).SpecialCells(xlCellTypeConstants)
        L3Value = cell.Value
        If L3Value <> "*" Then ' Ignore the "*" (All Data)
            
            ' Create a dictionary to store unique L4 values for this L3
            Set dictL4 = CreateObject("Scripting.Dictionary")
            For Each rngL4 In wsOptions.Range("D2:D" & lastRow)
                If rngL4.Value = L3Value Then
                    dictL4(rngL4.Offset(0, 1).Value) = 1 ' Column E (L4)
                End If
            Next rngL4
            
            ' Filter Data sheet to keep only rows where Column G = L3Value
            wsData.Range("A2").AutoFilter Field:=7, Criteria1:=L3Value
            
            ' Delete rows that do not match the selected L3
            lastRowData = wsData.Cells(wsData.Rows.Count, 1).End(xlUp).Row
            For Each rng In wsData.Range("G3:G" & lastRowData)
                If rng.Value <> L3Value Then
                    If delRow Is Nothing Then
                        Set delRow = rng.EntireRow
                    Else
                        Set delRow = Union(delRow, rng.EntireRow)
                    End If
                End If
            Next rng
            If Not delRow Is Nothing Then delRow.Delete
            wsData.ShowAllData
            
            ' Update L3 Summary B1 with the selected L3
            wsL3.Range("B1").Value = L3Value
            
            ' Update L4 Summary B1 with only relevant L4 values
            wsL4.Range("B1").Validation.Delete ' Remove old dropdown
            wsL4.Range("B1").Validation.Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, _
                Operator:=xlBetween, Formula1:=Join(dictL4.Keys, ",")
            
            ' Create a new workbook
            Set wbNew = Workbooks.Add
            wsL3.Copy Before:=wbNew.Sheets(1)
            wsL4.Copy Before:=wbNew.Sheets(1)
            wsData.Copy Before:=wbNew.Sheets(1)
            ThisWorkbook.Sheets("Readme").Copy Before:=wbNew.Sheets(1)
            ThisWorkbook.Sheets("Mapping").Copy Before:=wbNew.Sheets(1)
            
            ' Delete Reg Summary (not needed for L3 split)
            On Error Resume Next
            wbNew.Sheets("Reg Summary").Delete
            On Error GoTo 0
            
            ' Save the new file
            fileName = ThisWorkbook.Path & "\" & L3Value & ".xlsx"
            wbNew.SaveAs fileName, FileFormat:=xlOpenXMLWorkbook
            wbNew.Close False
            
            ' Cleanup
            Set dictL4 = Nothing
            Set delRow = Nothing
            
        End If
    Next cell
    
    ' Reset screen updates
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True

    MsgBox "Splitting complete!", vbInformation, "Done"
End Sub
