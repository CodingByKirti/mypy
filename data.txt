Sub UpdateL3AndL4Summaries()
    Dim wsOptions As Worksheet, wsL3Summary As Worksheet, wsL4Summary As Worksheet
    Dim lastRowOptions As Long, rngL3 As Range, rngL4 As Range, cell As Range
    Dim L3 As String, L4Values As String, NewFileName As String
    Dim dvRange As Range, wsData As Worksheet
    Dim L4Dict As Object
    
    ' Set references to sheets
    Set wsOptions = ThisWorkbook.Sheets("Options")
    Set wsL3Summary = ThisWorkbook.Sheets("L3 Summary")
    Set wsL4Summary = ThisWorkbook.Sheets("L4 Summary")
    
    ' Extract L3 name from the filename (current workbook name)
    NewFileName = ThisWorkbook.Name
    L3 = Left(NewFileName, InStrRev(NewFileName, ".") - 1) ' Remove ".xlsx"
    
    ' Update B1 in "L3 Summary" sheet
    wsL3Summary.Range("B1").Value = L3
    
    ' Find all corresponding L4 values for this L3
    lastRowOptions = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row
    Set L4Dict = CreateObject("Scripting.Dictionary")
    
    For Each cell In wsOptions.Range("D2:D" & lastRowOptions)
        If cell.Value = L3 Then
            If Not L4Dict.Exists(cell.Offset(0, 1).Value) Then
                L4Dict.Add cell.Offset(0, 1).Value, Nothing
            End If
        End If
    Next cell
    
    ' Create a comma-separated list of L4 values
    L4Values = Join(L4Dict.Keys, ",")
    
    ' Set dropdown in B1 of "L4 Summary"
    With wsL4Summary.Range("B1").Validation
        .Delete
        .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:= _
            xlBetween, Formula1:=L4Values
        .IgnoreBlank = True
        .InCellDropdown = True
        .ShowInput = True
        .ShowError = True
    End With

    MsgBox "Updated L3 Summary and L4 Summary dropdown!", vbInformation, "Done"
End Sub
