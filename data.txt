Sub GenerateL3Files()
    Dim wsOptions As Worksheet, wsData As Worksheet
    Dim wbMain As Workbook, wbCopy As Workbook
    Dim L3 As Range, L3Cell As Range
    Dim lastRow As Long, lastRowData As Long
    Dim L3List As Object
    Dim NewFilePath As String
    Dim folderPath As String
    Dim fileName As String
    Dim mainFilePath As String
    
    ' Disable alerts and screen updating
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Set references
    Set wbMain = ThisWorkbook
    Set wsOptions = wbMain.Sheets("Options")
    Set wsData = wbMain.Sheets("Data")

    ' Find last row in Options sheet Column D
    lastRow = wsOptions.Cells(wsOptions.Rows.Count, 4).End(xlUp).Row
    
    ' Create a dictionary to store unique L3 values
    Set L3List = CreateObject("Scripting.Dictionary")

    ' Loop through column D and collect unique L3 values
    For Each L3Cell In wsOptions.Range("D2:D" & lastRow)
        If Not L3List.exists(L3Cell.Value) And L3Cell.Value <> "" Then
            L3List.Add L3Cell.Value, Nothing
        End If
    Next L3Cell

    ' Create output folder if not exists
    folderPath = wbMain.Path & "\L3_Files\"
    If Dir(folderPath, vbDirectory) = "" Then MkDir folderPath

    ' Get the main file path
    mainFilePath = wbMain.FullName

    ' Loop through unique L3 values and create copies
    For Each L3 In L3List.keys()
        ' Define new file name
        fileName = L3 & ".xlsx"
        NewFilePath = folderPath & fileName

        ' Save a copy of the main file
        wbMain.SaveCopyAs NewFilePath
        
        ' Open the new copy
        Set wbCopy = Workbooks.Open(NewFilePath)

        ' Delete "Reg Summary" sheet if it exists
        On Error Resume Next
        wbCopy.Sheets("Reg Summary").Delete
        On Error GoTo 0

        ' Set reference to Data sheet
        Set wsData = wbCopy.Sheets("Data")

        ' Find last row of data in column G
        lastRowData = wsData.Cells(wsData.Rows.Count, 7).End(xlUp).Row

        ' Apply filter in Data sheet and delete rows not matching L3
        wsData.Rows(2).AutoFilter Field:=7, Criteria1:=L3
        wsData.Range("A3:A" & lastRowData).SpecialCells(xlCellTypeVisible).EntireRow.Delete
        wsData.AutoFilterMode = False

        ' Refresh formulas
        wbCopy.RefreshAll
        
        ' Set sensitivity label (try to bypass prompt)
        On Error Resume Next
        wbCopy.SensitivityLabelPolicy.SetLabel "Internal"
        On Error GoTo 0

        ' Save and close
        wbCopy.Save
        wbCopy.Close False
    Next L3

    ' Re-enable alerts and screen updating
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True

    MsgBox "All L3 files created successfully!", vbInformation
End Sub
