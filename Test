def write_to_ppt(level4_id, ppt_path="OrgChart_Output.pptx"):
    """
    Generate PPT slides:
    - Level 4 manager header repeated on each slide.
    - L5 employees batched into groups of 7 per slide.
    - For each L5:
        * If ≤7 L6 → show inline under L5, each with "Reports: N" (+ open positions).
        * If >7 L6 → show only "Direct Reports: N" in main slide, then create separate slide(s)
          for that L5 with all their L6 (batched into 7).
    - L6 lines show only counts (no names/titles).
    """
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()

    def add_slide(header_text, block_lines):
        slide = pres.Slides.Add(pres.Slides.Count + 1, 12)  # Title-only layout
        shape = slide.Shapes.AddTextbox(1, 50, 50, 820, 420)
        shape.TextFrame.TextRange.Text = "\r".join([header_text] + block_lines)

    def batch_list(items, size=7):
        return [items[i:i+size] for i in range(0, len(items), size)]

    # Level 4 header
    level4_header = person_header(level4_id)

    # Get all L5 employees under Level 4
    l5_reports = get_direct_reports(level4_id)

    # Build structured blocks for each L5
    overflow_l5_ids = []
    l5_structs = []

    for _, l5 in l5_reports.iterrows():
        l5_id = l5["Employee ID"]
        if pd.isna(l5_id):
            continue

        l5_header = person_header(l5_id)
        l6_reports = get_direct_reports(l5_id)
        l6_count = l6_reports.shape[0]

        if l6_count == 0:
            # Just L5 header
            l5_structs.append([l5_header])
        elif l6_count <= 7:
            # L5 header + inline L6 counts
            block = [l5_header]
            for _, l6 in l6_reports.iterrows():
                l6_id = l6["Employee ID"]
                if pd.isna(l6_id):
                    continue
                block.append("\t" + l6_line(l6_id))
            l5_structs.append(block)
        else:
            # Overflow case: only L5 header + DR count in main slide
            l5_structs.append([l5_header, f"\t→ Direct Reports: {l6_count}"])
            overflow_l5_ids.append(l5_id)

    # Batch L5 structs into groups of 7 for Level 4 slides
    for chunk in batch_list(l5_structs, size=7):
        # Flatten each L5 struct into a block of lines
        block_lines = []
        for block in chunk:
            block_lines.extend(block)
        add_slide(level4_header, block_lines)

    # Create overflow slides for each L5 with >7 L6
    for l5_id in overflow_l5_ids:
        l5_header = person_header(l5_id)
        l6_reports = get_direct_reports(l5_id)

        l6_lines = []
        for _, l6 in l6_reports.iterrows():
            l6_id = l6["Employee ID"]
            if pd.isna(l6_id):
                continue
            l6_lines.append(l6_line(l6_id))

        for chunk in batch_list(l6_lines, size=7):
            add_slide(l5_header, chunk)

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")
    return pres

...................................................................
............................................

import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# --- Helper functions ---
def is_missing(val):
    if pd.isna(val):
        return True
    s = str(val).strip()
    return s == "" or s.lower() == "unspecified"

def get_direct_reports(manager_id):
    return (
        df_final[df_final["Functional Manager Employee ID"] == manager_id]
        .drop_duplicates(subset=["Employee ID", "PID"])
        .copy()
    )

def person_header(emp_id):
    row = df_final[df_final["Employee ID"] == emp_id]
    if row.empty:
        return "<unknown>"
    r = row.iloc[0]
    header = f"{r.get('Employee Name','')} | {r.get('Position Title','<blank>')}\n{r.get('GCB','')} | {r.get('Country R3','')}"
    op = open_pos_counts.get(emp_id, 0)
    if op > 0:
        header += f"\n→ Open Positions: {op}"
    return header

def l6_line(emp_id):
    l7_count = direct_counts.get(emp_id, 0)
    line = f"→ Reports: {l7_count}"
    op = open_pos_counts.get(emp_id, 0)
    if op > 0:
        line += f"\n→ Open Positions: {op}"
    return line

# --- Step 3: Build indented hierarchy for Excel ---
def build_indented_lines_for_level4(level4_id):
    lines = []
    overflow_l5_ids = []

    # Level 4 header
    lines.append(person_header(level4_id))

    # All Level 5 under this Level 4
    l5_reports = get_direct_reports(level4_id)

    for _, l5 in l5_reports.iterrows():
        l5_id = l5["Employee ID"]
        if pd.isna(l5_id):
            continue

        l5_hdr = person_header(l5_id)
        l6_reports = get_direct_reports(l5_id)
        l6_count = l6_reports.shape[0]

        if l6_count == 0:
            lines.append(f"\t{l5_hdr}")
        elif l6_count <= 7:
            lines.append(f"\t{l5_hdr}")
            for _, l6 in l6_reports.iterrows():
                l6_id = l6["Employee ID"]
                if pd.isna(l6_id):
                    continue
                lines.append(f"\t\t{l6_line(l6_id)}")
        else:
            lines.append(f"\t{l5_hdr}\n\t→ Direct Reports: {l6_count}")
            overflow_l5_ids.append(l5_id)

    return lines, overflow_l5_ids

def export_indented_to_excel(level4_id, excel_path="OrgChart_Indented.xlsx"):
    lines, overflow_l5_ids = build_indented_lines_for_level4(level4_id)
    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return overflow_l5_ids

# --- Step 4: PowerPoint generation ---
def write_to_ppt(level4_id, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()

    def add_slide_with_lines(header_text, block_lines):
        slide = pres.Slides.Add(pres.Slides.Count + 1, 12)
        shape = slide.Shapes.AddTextbox(1, 50, 50, 820, 420)
        shape.TextFrame.TextRange.Text = "\r".join([header_text] + block_lines)

    def batch_list(items, size=7):
        return [items[i:i+size] for i in range(0, len(items), size)]

    # Level 4 header and all L5
    level4_header = person_header(level4_id)
    l5_reports = get_direct_reports(level4_id)

    l5_blocks = []
    overflow_l5_ids = []

    for _, l5 in l5_reports.iterrows():
        l5_id = l5["Employee ID"]
        if pd.isna(l5_id):
            continue

        block_lines = [person_header(l5_id)]
        l6_reports = get_direct_reports(l5_id)
        l6_count = l6_reports.shape[0]

        if l6_count == 0:
            pass
        elif l6_count <= 7:
            for _, l6 in l6_reports.iterrows():
                l6_id = l6["Employee ID"]
                if pd.isna(l6_id):
                    continue
                block_lines.append("\t" + l6_line(l6_id))
        else:
            block_lines.append(f"\t→ Direct Reports: {l6_count}")
            overflow_l5_ids.append(l5_id)

        l5_blocks.append("\n".join(block_lines))

    # Batch L5 blocks into groups of 7 for Level 4 slides
    for chunk in batch_list(l5_blocks, size=7):
        add_slide_with_lines(level4_header, chunk)

    # Overflow slides for L5 with >7 L6
    for l5_id in overflow_l5_ids:
        l5_header = person_header(l5_id)
        l6_reports = get_direct_reports(l5_id)

        l6_lines = []
        for _, l6 in l6_reports.iterrows():
            l6_id = l6["Employee ID"]
            if pd.isna(l6_id):
                continue
            l6_lines.append(l6_line(l6_id))

        for chunk in batch_list(l6_lines, size=7):
            add_slide_with_lines(l5_header, chunk)

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")
    return pres

# --- Orchestration ---
root = tk.Tk()
root.withdraw()
level4_id = simpledialog.askinteger("Input", "Enter Level 4 Manager Employee ID:")

overflow_l5_ids = export_indented_to_excel(level4_id, "OrgChart_Indented.xlsx")
write_to_ppt(level4_id, "OrgChart_Output.pptx")


....................................

import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# --- Helper to detect missing values robustly ---
def is_missing(val):
    if pd.isna(val):
        return True
    s = str(val).strip()
    return s == "" or s.lower() == "unspecified"

# Step 1: Read base org data (ACTUALS)
df = pd.read_excel("org_data.xlsx", skiprows=1, sheet_name="Data")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df (ID-based)
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")
df["Position Title"] = df["Position Title"].fillna("<blank>")

# Step 1c: Re-read org_data.xlsx for open positions
needed_cols = ["Employee ID","Employee Name","Functional Manager Employee ID",
               "Functional Manager Employee Name","Stack","FTE FCST","PID"]
df_base = pd.read_excel("org_data.xlsx", skiprows=1, sheet_name="Data", usecols=needed_cols)

mask = (
    (df_base["Stack"] != "ACTUALS") &
    (df_base["FTE FCST"] > 0) &
    df_base["PID"].apply(lambda x: not is_missing(x))
)
df_open_candidates = df_base[mask].drop_duplicates(subset=["PID"]).copy()

# Step 1d: Load open_position.xlsx
open_pos = pd.read_excel("open_position.xlsx",
                         usecols=["Position Number","Position Title",
                                  "Functional Manager Position Level Employee ID",
                                  "Functional Manager Position Level Employee Name"])
for col in open_pos.columns:
    open_pos[col] = open_pos[col].astype(str).str.strip().replace("Unspecified","")

open_pos["Position Number"] = pd.to_numeric(open_pos["Position Number"], errors="coerce").astype("Int64")
open_pos["Functional Manager Position Level Employee ID"] = pd.to_numeric(open_pos["Functional Manager Position Level Employee ID"], errors="coerce").astype("Int64")

# Step 1e: Merge candidates with open pos report (ID-based)
df_open_candidates["PID"] = pd.to_numeric(df_open_candidates["PID"], errors="coerce").astype("Int64")
df_open_enriched = df_open_candidates.merge(
    open_pos,
    left_on="PID",
    right_on="Position Number",
    how="left"
)

# Skip rows where Position Number is missing
df_open_enriched = df_open_enriched[~df_open_enriched["Position Number"].isna()].copy()

# Add placeholders for open positions
df_open_enriched["Employee ID"] = pd.NA
df_open_enriched["Employee Name"] = ""
df_open_enriched["Position Title"] = df_open_enriched["Position Title"].fillna("<blank>")

# Step 1f: Combine ACTUALS + Open Positions
df_final = pd.concat([df, df_open_enriched], ignore_index=True)
df_final = df_final.drop_duplicates(subset=["Employee ID","PID"], keep="first")

# Step 2: Precompute counts
open_pos_counts = (
    df_open_enriched.groupby("Functional Manager Position Level Employee ID")
    .size()
    .to_dict()
)
direct_counts = (
    df_final.groupby("Functional Manager Employee ID")
    .size()
    .to_dict()
)

output_rows = []
overflow_managers = []

def traverse_level5(level4_id):
    level5_reports = df_final[df_final["Functional Manager Employee ID"] == level4_id].drop_duplicates(subset=["Employee ID","PID"])
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]
        if is_missing(l5_id):
            continue
        level6_reports = df_final[df_final["Functional Manager Employee ID"] == l5_id].drop_duplicates(subset=["Employee ID","PID"])
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0, l5.get("PID",""), l5.get("Position Title","")])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df_final[df_final["Functional Manager Employee ID"] == l6_id].drop_duplicates(subset=["Employee ID","PID"]).shape[0]
                output_rows.append([level4_id, l5_id, l6_id, count, l6.get("PID",""), l6.get("Position Title","")])

# Step 3: Export indented hierarchy with details
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    if level4_id is not None:
        mgr_row = df_final[df_final["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','<blank>')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        count_open = open_pos_counts.get(level4_id, 0)
        if count_open > 0:
            mgr_details += f"\n→ Open Positions: {count_open}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df_final[df_final["Employee ID"] == l5_id].iloc[0]
            l5_details = (
                f"{l5_row.get('Employee Name','')} | {l5_row.get('Position Title','<blank>')}\n"
                f"{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            )
            count_open = open_pos_counts.get(l5_id, 0)
            if count_open > 0:
                l5_details += f"\n→ Open Positions: {count_open}"
            count_reports = direct_counts.get(l5_id, 0)
            if count_reports > 7:   # overflow rule for Level-5
                l5_details += f"\n→ Direct Reports: {count_reports}"
                overflow_managers.append(l5_id)
            lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]
            if pd.notna(l6_id):
                l6_row = df_final[df_final["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row.get('Employee Name','')} | {l6_row.get('Position Title','<blank>')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                count_open = open_pos_counts.get(l6_id, 0)
                if count_open > 0:
                    l6_details += f"\n→ Open Positions: {count_open}"
                if count > 7:   # overflow rule for Level-6
                    overflow_managers.append(l6_id)
                lines.append(f"\t\t{l6_details}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines


# Step 4: Write to PowerPoint with batching + overflow
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx", level4_id=None):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()

    # Helper to create slides in batches of 7
    def create_batched_slides(header, report_lines):
        chunks = [report_lines[i:i+7] for i in range(0, len(report_lines), 7)]
        for chunk in chunks:
            slide = pres.Slides.Add(pres.Slides.Count+1, 12)
            textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
            textbox.TextFrame.TextRange.Text = "\r".join([header] + chunk)

    # Level-4 batching
    mgr_header = lines[0]
    report_lines = lines[1:]
    create_batched_slides(mgr_header, report_lines)

    # Add overflow slides for managers (Level-5 or Level-6 with >7 reports)
    for mgr_id in overflow_managers:
        mgr_row = df_final[df_final["Employee ID"] == mgr_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','<blank>')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        count_open = open_pos_counts.get(mgr_id, 0)
        if count_open > 0:
            mgr_details += f"\n→ Open Positions: {count_open}"

        # Collect all direct reports of this overflow manager
        mgr_reports = df_final[df_final["Functional Manager Employee ID"] == mgr_id].drop_duplicates(subset=["Employee ID","PID"])
        report_lines = []
        for _, rep in mgr_reports.iterrows():
            rep_details = f"{rep.get('Employee Name','')} | {rep.get('Position Title','<blank>')}\n{rep.get('GCB','')} | {rep.get('Country R3','')}"
            count_reports = direct_counts.get(rep["Employee ID"], 0)
            if count_reports > 0:
                rep_details += f"\n→ Reports: {count_reports}"
            count_open = open_pos_counts.get(rep["Employee ID"], 0)
            if count_open > 0:
                rep_details += f"\n→ Open Positions: {count_open}"
            report_lines.append(f"\t{rep_details}")

        # Batch these reportees into slides of 7
        create_batched_slides(mgr_details, report_lines)

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")
    return pres


# --- Ask user for Level 4 Manager Employee ID ---
root = tk.Tk()
root.withdraw()
level4_id = simpledialog.askinteger("Input", "Enter Level 4 Manager Employee ID:")

# --- Traverse hierarchy ---
traverse_level5(level4_id)

# --- Build DataFrame ---
out_df = pd.DataFrame(output_rows, columns=[
    "Level 4 Employee ID","Level 5 Employee ID","Level 6 Employee ID",
    "Count of Direct Reports","PID","Position Title"
])

# --- Export hierarchy to Excel and capture lines ---
lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", level4_id=level4_id)

# --- Write those lines to PowerPoint ---
write_indented_to_ppt(lines, "OrgChart_Output.pptx", level4_id=level4_id)---- following is ok for op pos as well
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# --- Helper to detect missing values robustly ---
def is_missing(val):
    if pd.isna(val):
        return True
    s = str(val).strip()
    return s == "" or s.lower() == "unspecified"

# Step 1: Read base org data (ACTUALS)
df = pd.read_excel("org_data.xlsx", skiprows=1, sheet_name="Data")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df (ID-based)
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")
df["Position Title"] = df["Position Title"].fillna("<blank>")

# Step 1c: Re-read org_data.xlsx for open positions
needed_cols = ["Employee ID","Employee Name","Functional Manager Employee ID",
               "Functional Manager Employee Name","Stack","FTE FCST","PID"]
df_base = pd.read_excel("org_data.xlsx", skiprows=1, sheet_name="Data", usecols=needed_cols)

mask = (
    (df_base["Stack"] != "ACTUALS") &
    (df_base["FTE FCST"] > 0) &
    df_base["PID"].apply(lambda x: not is_missing(x))
)
df_open_candidates = df_base[mask].drop_duplicates(subset=["PID"]).copy()

# Step 1d: Load open_position.xlsx
open_pos = pd.read_excel("open_position.xlsx",
                         usecols=["Position Number","Position Title",
                                  "Functional Manager Position Level Employee ID",
                                  "Functional Manager Position Level Employee Name"])
for col in open_pos.columns:
    open_pos[col] = open_pos[col].astype(str).str.strip().replace("Unspecified","")

open_pos["Position Number"] = pd.to_numeric(open_pos["Position Number"], errors="coerce").astype("Int64")
open_pos["Functional Manager Position Level Employee ID"] = pd.to_numeric(open_pos["Functional Manager Position Level Employee ID"], errors="coerce").astype("Int64")

# Step 1e: Merge candidates with open pos report (ID-based)
df_open_candidates["PID"] = pd.to_numeric(df_open_candidates["PID"], errors="coerce").astype("Int64")
df_open_enriched = df_open_candidates.merge(
    open_pos,
    left_on="PID",
    right_on="Position Number",
    how="left"
)

# Skip rows where Position Number is missing
df_open_enriched = df_open_enriched[~df_open_enriched["Position Number"].isna()].copy()

# Add placeholders for open positions
df_open_enriched["Employee ID"] = pd.NA
df_open_enriched["Employee Name"] = ""
df_open_enriched["Position Title"] = df_open_enriched["Position Title"].fillna("<blank>")

# Step 1f: Combine ACTUALS + Open Positions
df_final = pd.concat([df, df_open_enriched], ignore_index=True)
df_final = df_final.drop_duplicates(subset=["Employee ID","PID"], keep="first")

# Step 2: Precompute counts
open_pos_counts = (
    df_open_enriched.groupby("Functional Manager Position Level Employee ID")
    .size()
    .to_dict()
)
direct_counts = (
    df_final.groupby("Functional Manager Employee ID")
    .size()
    .to_dict()
)

output_rows = []
overflow_managers = []

def traverse_level5(level4_id):
    level5_reports = df_final[df_final["Functional Manager Employee ID"] == level4_id].drop_duplicates(subset=["Employee ID","PID"])
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]
        if is_missing(l5_id):
            continue
        level6_reports = df_final[df_final["Functional Manager Employee ID"] == l5_id].drop_duplicates(subset=["Employee ID","PID"])
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0, l5.get("PID",""), l5.get("Position Title","")])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df_final[df_final["Functional Manager Employee ID"] == l6_id].drop_duplicates(subset=["Employee ID","PID"]).shape[0]
                output_rows.append([level4_id, l5_id, l6_id, count, l6.get("PID",""), l6.get("Position Title","")])

# Step 3: Export indented hierarchy with details
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    if level4_id is not None:
        mgr_row = df_final[df_final["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','<blank>')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        count_open = open_pos_counts.get(level4_id, 0)
        if count_open > 0:
            mgr_details += f"\n→ Open Positions: {count_open}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df_final[df_final["Employee ID"] == l5_id].iloc[0]
            l5_details = f"{l5_row.get('Position Title','<blank>')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            count_open = open_pos_counts.get(l5_id, 0)
            if count_open > 0:
                l5_details += f"\n→ Open Positions: {count_open}"
            count_reports = direct_counts.get(l5_id, 0)
            if count_reports > 10:
                l5_details += f"\n→ Direct Reports: {count_reports} (see next slide)"
                overflow_managers.append(l5_id)
            lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]
            if pd.notna(l6_id):
                l6_row = df_final[df_final["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row.get('Position Title','<blank>')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                count_open = open_pos_counts.get(l6_id, 0)
                if count_open > 0:
                    l6_details += f"\n→ Open Positions: {count_open}"
                count_reports = direct_counts.get(l6_id, 0)
                if count_reports > 10:
                    l6_details += f"\n→ Direct Reports: {count_reports} (see next slide)"
                    overflow_managers.append(l6_id)
                lines.append(f"\t\t{l6_details}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    tr.Text = "\r".join(lines)

    # Add extra slides for overflow managers
    for mgr_id in overflow_managers:
        mgr_reports = df_final[df_final["Functional Manager Employee ID"] == mgr_id].drop_duplicates(subset=["Employee ID","PID"])
        mgr_row = df_final[df_final["Employee ID"] == mgr_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','<blank>')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        report_lines = [mgr_details]

        for _, rep in mgr_reports.iterrows():
            if pd.notna(rep["Employee ID"]):
                rep_id = rep["Employee ID"]
                rep_details = f"{rep.get('Position Title','<blank>')}\n{rep.get('GCB','')} | {rep.get('Country R3','')}"
                # Add direct reports count
                count_reports = df_final[df_final["Functional Manager Employee ID"] == rep_id].drop_duplicates(subset=["Employee ID","PID"]).shape[0]
                if count_reports > 0:
                    rep_details += f"\n→ Reports: {count_reports}"
                # Add open positions count
                count_open = open_pos_counts.get(rep_id, 0)
                if count_open > 0:
                    rep_details += f"\n→ Open Positions: {count_open}"
                report_lines.append(f"\t{rep_details}")

        slide = pres.Slides.Add(pres.Slides.Count+1, 12)
        textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
        textbox.TextFrame.TextRange.Text = "\r".join(report_lines)

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")
    return pres
#write_indented_to_ppt(lines, "OrgChart_Output.pptx")

# --- Ask user for Level 4 Manager Employee ID ---
root = tk.Tk()
root.withdraw()  # hide Tkinter main window
level4_id = simpledialog.askinteger("Input", "Enter Level 4 Manager Employee ID:")

# --- Traverse hierarchy for that manager ---
traverse_level5(level4_id)

# --- Build DataFrame from collected rows ---
out_df = pd.DataFrame(output_rows, columns=[
    "Level 4 Employee ID","Level 5 Employee ID","Level 6 Employee ID",
    "Count of Direct Reports","PID","Position Title"
])

# --- Export hierarchy to Excel and capture lines ---
lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", level4_id=level4_id)

# --- Write those lines to PowerPoint ---
write_indented_to_ppt(lines, "OrgChart_Output.pptx")
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>






....................................................

Here is a more polished and senior-management-friendly version:

---

**Subject:** Monthly Hybrid Workstyle Dashboard – Confirmation on Gurugram Threshold

Dear Team,

Please find attached the monthly Hybrid Workstyle Dashboard report.

As the comparison metrics may vary with the revised guidelines, we have currently retained the **Gurugram office threshold at 1 day**.
Requesting your confirmation on whether this should be updated to **2 days effective 1st December** or **1st January**, so we can align the reporting accordingly.

Thank you,
[Your Name]

---

If you want it to sound even more formal or add a justification line, I can refine it further.



# Keep track of managers needing extra slides
overflow_managers = []

def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    if level4_id is not None:
        mgr_row = df_final[df_final["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df_final[df_final["Employee ID"] == l5_id].iloc[0]
            l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            count_reports = direct_counts.get(l5_id, 0)
            if count_reports > 10:
                l5_details += f"\n→ Direct Reports: {count_reports} (see next slide)"
                overflow_managers.append(l5_id)
            lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]

            if pd.notna(l6_id):
                l6_row = df_final[df_final["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                count_reports = direct_counts.get(l6_id, 0)
                if count_reports > 10:
                    l6_details += f"\n→ Direct Reports: {count_reports} (see next slide)"
                    overflow_managers.append(l6_id)
                lines.append(f"\t\t{l6_details}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    tr.Text = "\r".join(lines)

    # Add extra slides for overflow managers
    for mgr_id in overflow_managers:
        mgr_reports = df_final[df_final["Functional Manager Employee ID"] == mgr_id]
        mgr_row = df_final[df_final["Employee ID"] == mgr_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        report_lines = [mgr_details]
        for _, rep in mgr_reports.iterrows():
            if pd.notna(rep["Employee ID"]):
                rep_details = f"{rep['Employee Name']} | {rep.get('Position Title','')}\n{rep.get('GCB','')} | {rep.get('Country R3','')}"
                report_lines.append(f"\t{rep_details}")
        slide = pres.Slides.Add(pres.Slides.Count+1, 12)
        textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
        textbox.TextFrame.TextRange.Text = "\r".join(report_lines)

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# Step: Aggregate open positions by manager
open_pos_counts = (
    df_open_enriched.groupby("Functional Manager Position Level Employee ID")
    .size()
    .to_dict()
)

# Step 3: Export indented hierarchy with details (employees + open position counts)
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    if level4_id is not None:
        mgr_row = df_final[df_final["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        # Add open positions count for Level 4 manager
        count_open = open_pos_counts.get(level4_id, 0)
        if count_open > 0:
            mgr_details += f"\n→ Open Positions: {count_open}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df_final[df_final["Employee ID"] == l5_id].iloc[0]
            l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            # Add open positions count for Level 5
            count_open = open_pos_counts.get(l5_id, 0)
            if count_open > 0:
                l5_details += f"\n→ Open Positions: {count_open}"
            lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]

            if pd.notna(l6_id):
                l6_row = df_final[df_final["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                # Add open positions count for Level 6
                count_open = open_pos_counts.get(l6_id, 0)
                if count_open > 0:
                    l6_details += f"\n→ Open Positions: {count_open}"
                lines.append(f"\t\t{l6_details}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines
====

# addd open pos
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# --- Helper to detect missing values robustly ---
def is_missing(val):
    if pd.isna(val):
        return True
    s = str(val).strip()
    return s == "" or s.lower() == "unspecified"

# Step 1: Read base org data (ACTUALS)
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip().replace("Unspecified","")
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# Step 1c: Re-read org_data.xlsx for open positions
needed_cols = ["Employee ID","Employee Name","Functional Manager Employee ID",
               "Functional Manager Employee Name","Stack","FTE FCST","PID"]
df_base = pd.read_excel("org_data.xlsx", usecols=needed_cols)

mask = (
    (df_base["Stack"] != "ACTUALS") &
    (df_base["FTE FCST"] > 0) &
    df_base["PID"].apply(lambda x: not is_missing(x))
)
df_open_candidates = df_base[mask].drop_duplicates(subset=["PID"]).copy()

# Step 1d: Load open_position.xlsx
open_pos = pd.read_excel("open_position.xlsx",
                         usecols=["Position Number","Position Title",
                                  "Functional Manager Position Level Employee ID",
                                  "Functional Manager Position Level Employee Name"])
for col in open_pos.columns:
    open_pos[col] = open_pos[col].astype(str).str.strip().replace("Unspecified","")

open_pos["Position Number"] = pd.to_numeric(open_pos["Position Number"], errors="coerce").astype("Int64")
open_pos["Functional Manager Position Level Employee ID"] = pd.to_numeric(open_pos["Functional Manager Position Level Employee ID"], errors="coerce").astype("Int64")

# Step 1e: Merge candidates with open pos report
df_open_enriched = df_open_candidates.merge(
    open_pos,
    left_on="PID",
    right_on="Position Number",
    how="left"
)

# Skip rows where Position Number is missing (PID not found in open pos report)
df_open_enriched = df_open_enriched[~df_open_enriched["Position Number"].isna()].copy()

# Add placeholders for open positions
df_open_enriched["Employee ID"] = pd.NA
df_open_enriched["Employee Name"] = ""

# Step 1f: Combine ACTUALS + Open Positions
df_final = pd.concat([df, df_open_enriched], ignore_index=True)

# Step 2: Traverse Level 5/6 using IDs
output_rows = []

def traverse_level5(level4_id):
    level5_reports = df_final[df_final["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]

        if is_missing(l5_id):
            output_rows.append([level4_id, None, None, 0, l5.get("PID",""), l5.get("Position Title","")])
            continue

        level6_reports = df_final[df_final["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0, l5.get("PID",""), l5.get("Position Title","")])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df_final[df_final["Functional Manager Employee ID"] == l6_id].shape[0]

                if is_missing(l6_id):
                    output_rows.append([level4_id, l5_id, None, 0, l6.get("PID",""), l6.get("Position Title","")])
                else:
                    output_rows.append([level4_id, l5_id, l6_id, count, l6.get("PID",""), l6.get("Position Title","")])

# Step 3: Export indented hierarchy with details
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    if level4_id is not None:
        mgr_row = df_final[df_final["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df_final[df_final["Employee ID"] == l5_id].iloc[0]
            l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            lines.append(f"\t{l5_details}")
        else:
            pos_title = group["Position Title"].iloc[0]
            pid = group["PID"].iloc[0]
            lines.append(f"\tOpen Position ({pid}) | {pos_title}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]
            pid = row["PID"]
            pos_title = row["Position Title"]

            if pd.notna(l6_id):
                l6_row = df_final[df_final["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")
            else:
                lines.append(f"\t\tOpen Position ({pid}) | {pos_title}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager ID
root = tk.Tk()
root.withdraw()
manager_id_str = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Employee ID:")

if manager_id_str:
    try:
        manager_id = int(manager_id_str)
        if manager_id not in df_final["Employee ID"].values:
            print(f"Manager ID {manager_id} not found in data.")
        else:
            traverse_level5(manager_id)
            out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager ID","Level 5 Employee ID","Level 6 Employee ID","Count of Direct Reports","PID","Position Title"])
            out_df.to_excel("OrgChart_Flat.xlsx", index=False)

            lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_id)
            write_indented_to_ppt(lines, f"OrgChart_{manager_id}.pptx")
    except Exception as e:
        print(f"Error: {e}")
///////////////////
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# Step 1: Read base org data
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip()
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip()
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# Step 2: Traverse Level 5/6 using IDs
output_rows = []

def traverse_level5(level4_id):
    level5_reports = df[df["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]

        level6_reports = df[df["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df[df["Functional Manager Employee ID"] == l6_id].shape[0]
                output_rows.append([level4_id, l5_id, l6_id, count])

# Step 3: Export indented hierarchy with details (ID‑based)
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    # Root manager details
    if level4_id is not None:
        mgr_row = df[df["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        l5_row = df[df["Employee ID"] == l5_id].iloc[0]
        l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
        lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]

            if pd.notna(l6_id):
                l6_row = df[df["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")

    df_out = pd.DataFrame({"Hierarchy": lines})
    df_out.to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint (plain indented text, no SmartArt)
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager ID
root = tk.Tk()
root.withdraw()  # hide main window
manager_id_str = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Employee ID:")

if manager_id_str:
    try:
        manager_id = int(manager_id_str)
        if manager_id not in df["Employee ID"].values:
            print(f"Manager ID {manager_id} not found in data.")
        else:
            traverse_level5(manager_id)
            out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager ID","Level 5 Employee ID","Level 6 Employee ID","Count of Direct Reports"])
            out_df.to_excel("OrgChart_Flat.xlsx", index=False)

            lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_id)
            write_indented_to_ppt(lines, f"OrgChart_{manager_id}.pptx")
    except Exception as e:
        print(f"Error: {e}")

================================
-- based on names- (prob with ambuiguoty in names of employees--
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# Step 1: Read base org data
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].str.strip()
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].str.strip()
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# Step 2: Traverse Level 5/6
output_rows = []

def traverse_level5(level4_id, level4_name):
    level5_reports = df[df["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]
        l5_name = l5["Employee Name"]

        level6_reports = df[df["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_name, l5_name, "", 0])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                l6_name = l6["Employee Name"]
                count = df[df["Functional Manager Employee ID"] == l6_id].shape[0]
                output_rows.append([level4_name, l5_name, l6_name, count])

# Step 3: Export indented hierarchy with details
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_name="Manager"):
    lines = [level4_name]

    for l5_name, group in out_df.groupby("Level 5 Employee"):
        l5_row = df[df["Employee Name"] == l5_name].iloc[0]
        l5_details = f"{l5_name} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
        lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_name = row["Level 6 Employee"]
            count = row["Count of Direct Reports"]

            if l6_name:
                l6_row = df[df["Employee Name"] == l6_name].iloc[0]
                l6_details = (
                    f"{l6_name} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")

    df_out = pd.DataFrame({"Hierarchy": lines})
    df_out.to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint and convert to SmartArt Org Chart
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    # Convert textbox to SmartArt Org Chart
    try:
        textbox.ConvertToSmartArt()
        textbox.SmartArt.Layout = ppt.SmartArtLayouts("urn:microsoft.com/office/officeart/2005/8/layout/OrganizationChart")
        print("Converted to SmartArt Org Chart")
    except Exception as e:
        print(f"Could not convert to SmartArt: {e}")

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager name
root = tk.Tk()
root.withdraw()  # hide main window
manager_name = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Name:")

if manager_name:
    try:
        manager_id = df.loc[df["Employee Name"] == manager_name, "Employee ID"].iloc[0]
        traverse_level5(manager_id, manager_name)
        out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager","Level 5 Employee","Level 6 Employee","Count of Direct Reports"])
        out_df.to_excel("OrgChart_Flat.xlsx", index=False)

        lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_name)
        write_indented_to_ppt(lines, f"OrgChart_{manager_name.replace(' ','_')}.pptx")
    except IndexError:
        print(f"Manager '{manager_name}' not found in data.")
