# addd open pos
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# Step 1: Read base org data
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip()
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip()
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# --- Helper function for open position enrichment ---
def enrich_open_positions(base_df, open_pos_file="open_position_report.xlsx"):
    """
    Enrich base_df with open position details using PID.
    Treat 'Unspecified' as missing.
    """
    if "PID" not in base_df.columns:
        return base_df

    base_df["PID"] = base_df["PID"].astype(str).str.strip()

    # Load open position report
    open_pos = pd.read_excel(open_pos_file)

    # Normalize and replace 'Unspecified' with ''
    for col in [
        "Position Number",
        "Position Title",
        "Functional Manager Position Level Employee Name",
        "Functional Manager Position Level Employee ID",
    ]:
        if col in open_pos.columns:
            open_pos[col] = (
                open_pos[col].astype(str).str.strip().replace("Unspecified", "")
            )

    # Merge
    df_enriched = base_df.merge(
        open_pos[
            [
                "Position Number",
                "Position Title",
                "Functional Manager Position Level Employee Name",
                "Functional Manager Position Level Employee ID",
            ]
        ],
        left_on="PID",
        right_on="Position Number",
        how="left",
    )

    # Combine Position Title_x and Position Title_y
    if "Position Title_x" in df_enriched.columns and "Position Title_y" in df_enriched.columns:
        df_enriched["Position Title"] = df_enriched["Position Title_x"].replace("Unspecified","").fillna(
            df_enriched["Position Title_y"].replace("Unspecified","")
        )
        df_enriched = df_enriched.drop(columns=["Position Title_x", "Position Title_y"])

    # Fill missing Employee ID/Name with open pos manager linkage
    mask_open = (
        df_enriched["Employee ID"].isna()
        | (df_enriched["Employee Name"].astype(str).str.strip().replace("Unspecified","") == "")
    )
    df_enriched.loc[mask_open, "Employee Name"] = df_enriched.loc[
        mask_open, "Functional Manager Position Level Employee Name"
    ].replace("Unspecified","")
    df_enriched.loc[mask_open, "Employee ID"] = df_enriched.loc[
        mask_open, "Functional Manager Position Level Employee ID"
    ].replace("Unspecified","")

    return df_enriched

# Apply enrichment
df = enrich_open_positions(df, "open_position_report.xlsx")

# Step 2: Traverse Level 5/6 using IDs
output_rows = []

def traverse_level5(level4_id):
    level5_reports = df[df["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]

        level6_reports = df[df["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0, l5.get("PID","")])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df[df["Functional Manager Employee ID"] == l6_id].shape[0]
                output_rows.append([level4_id, l5_id, l6_id, count, l6.get("PID","")])

# Step 3: Export indented hierarchy with details (ID‑based + open positions)
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    # Root manager details
    if level4_id is not None:
        mgr_row = df[df["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        if pd.notna(l5_id):
            l5_row = df[df["Employee ID"] == l5_id].iloc[0]
            l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
            lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]
            pid = row.get("PID","")

            if pd.notna(l6_id):
                l6_row = df[df["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")
            else:
                # Handle open positions (no Employee ID/Name)
                pos_title = row.get("Position Title","")
                lines.append(f"\t\tOpen Position ({pid}) | {pos_title}")

    pd.DataFrame({"Hierarchy": lines}).to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint (plain indented text, no SmartArt)
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager ID
root = tk.Tk()
root.withdraw()  # hide main window
manager_id_str = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Employee ID:")

if manager_id_str:
    try:
        manager_id = int(manager_id_str)
        if manager_id not in df["Employee ID"].values:
            print(f"Manager ID {manager_id} not found in data.")
        else:
            traverse_level5(manager_id)
            out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager ID","Level 5 Employee ID","Level 6 Employee ID","Count of Direct Reports","PID"])
            out_df.to_excel("OrgChart_Flat.xlsx", index=False)

            lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_id)
            write_indented_to_ppt(lines, f"OrgChart_{manager_id}.pptx")
    except Exception as e:
        print(f"Error: {e}")
///////////////////
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# Step 1: Read base org data
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].astype(str).str.strip()
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].astype(str).str.strip()
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# Step 2: Traverse Level 5/6 using IDs
output_rows = []

def traverse_level5(level4_id):
    level5_reports = df[df["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]

        level6_reports = df[df["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_id, l5_id, None, 0])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                count = df[df["Functional Manager Employee ID"] == l6_id].shape[0]
                output_rows.append([level4_id, l5_id, l6_id, count])

# Step 3: Export indented hierarchy with details (ID‑based)
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_id=None):
    lines = []
    # Root manager details
    if level4_id is not None:
        mgr_row = df[df["Employee ID"] == level4_id].iloc[0]
        mgr_details = f"{mgr_row['Employee Name']} | {mgr_row.get('Position Title','')}\n{mgr_row.get('GCB','')} | {mgr_row.get('Country R3','')}"
        lines.append(mgr_details)

    for l5_id, group in out_df.groupby("Level 5 Employee ID"):
        l5_row = df[df["Employee ID"] == l5_id].iloc[0]
        l5_details = f"{l5_row['Employee Name']} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
        lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_id = row["Level 6 Employee ID"]
            count = row["Count of Direct Reports"]

            if pd.notna(l6_id):
                l6_row = df[df["Employee ID"] == l6_id].iloc[0]
                l6_details = (
                    f"{l6_row['Employee Name']} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")

    df_out = pd.DataFrame({"Hierarchy": lines})
    df_out.to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint (plain indented text, no SmartArt)
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager ID
root = tk.Tk()
root.withdraw()  # hide main window
manager_id_str = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Employee ID:")

if manager_id_str:
    try:
        manager_id = int(manager_id_str)
        if manager_id not in df["Employee ID"].values:
            print(f"Manager ID {manager_id} not found in data.")
        else:
            traverse_level5(manager_id)
            out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager ID","Level 5 Employee ID","Level 6 Employee ID","Count of Direct Reports"])
            out_df.to_excel("OrgChart_Flat.xlsx", index=False)

            lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_id)
            write_indented_to_ppt(lines, f"OrgChart_{manager_id}.pptx")
    except Exception as e:
        print(f"Error: {e}")

================================
-- based on names- (prob with ambuiguoty in names of employees--
import pandas as pd
import win32com.client
import tkinter as tk
from tkinter import simpledialog

# Step 1: Read base org data
df = pd.read_excel("org_data.xlsx")
df["Employee Name"] = df["Employee Name"].str.strip()
df["Functional Manager Employee Name"] = df["Functional Manager Employee Name"].str.strip()
df["Employee ID"] = pd.to_numeric(df["Employee ID"], errors="coerce").astype("Int64")
df["Functional Manager Employee ID"] = pd.to_numeric(df["Functional Manager Employee ID"], errors="coerce").astype("Int64")

# Step 1b: Read lookup file for Position Title
lookup = pd.read_excel("ghaOct.xlsx", sheet_name="Headcount - Employee Detail")
lookup["Employee ID"] = pd.to_numeric(lookup["Employee ID"], errors="coerce").astype("Int64")

# Merge Position Title into df
df = df.merge(lookup[["Employee ID","Position Title"]], on="Employee ID", how="left")

# Step 2: Traverse Level 5/6
output_rows = []

def traverse_level5(level4_id, level4_name):
    level5_reports = df[df["Functional Manager Employee ID"] == level4_id]
    for _, l5 in level5_reports.iterrows():
        l5_id = l5["Employee ID"]
        l5_name = l5["Employee Name"]

        level6_reports = df[df["Functional Manager Employee ID"] == l5_id]
        if level6_reports.empty:
            output_rows.append([level4_name, l5_name, "", 0])
        else:
            for _, l6 in level6_reports.iterrows():
                l6_id = l6["Employee ID"]
                l6_name = l6["Employee Name"]
                count = df[df["Functional Manager Employee ID"] == l6_id].shape[0]
                output_rows.append([level4_name, l5_name, l6_name, count])

# Step 3: Export indented hierarchy with details
def export_indented_to_excel(out_df, excel_path="OrgChart_Indented.xlsx", level4_name="Manager"):
    lines = [level4_name]

    for l5_name, group in out_df.groupby("Level 5 Employee"):
        l5_row = df[df["Employee Name"] == l5_name].iloc[0]
        l5_details = f"{l5_name} | {l5_row.get('Position Title','')}\n{l5_row.get('GCB','')} | {l5_row.get('Country R3','')}"
        lines.append(f"\t{l5_details}")

        for _, row in group.iterrows():
            l6_name = row["Level 6 Employee"]
            count = row["Count of Direct Reports"]

            if l6_name:
                l6_row = df[df["Employee Name"] == l6_name].iloc[0]
                l6_details = (
                    f"{l6_name} | {l6_row.get('Position Title','')}\n"
                    f"{l6_row.get('GCB','')} | {l6_row.get('Country R3','')}\n"
                    f"→ Reports: {count}"
                )
                lines.append(f"\t\t{l6_details}")

    df_out = pd.DataFrame({"Hierarchy": lines})
    df_out.to_excel(excel_path, index=False)
    print(f"Indented hierarchy exported to {excel_path}")
    return lines

# Step 4: Write to PowerPoint and convert to SmartArt Org Chart
def write_indented_to_ppt(lines, ppt_path="OrgChart_Output.pptx"):
    ppt = win32com.client.Dispatch("PowerPoint.Application")
    ppt.Visible = True
    pres = ppt.Presentations.Add()
    slide = pres.Slides.Add(1, 12)

    textbox = slide.Shapes.AddTextbox(1, 50, 50, 600, 400)
    tr = textbox.TextFrame.TextRange
    text_content = "\r".join(lines)
    tr.Text = text_content

    # Convert textbox to SmartArt Org Chart
    try:
        textbox.ConvertToSmartArt()
        textbox.SmartArt.Layout = ppt.SmartArtLayouts("urn:microsoft.com/office/officeart/2005/8/layout/OrganizationChart")
        print("Converted to SmartArt Org Chart")
    except Exception as e:
        print(f"Could not convert to SmartArt: {e}")

    pres.SaveAs(ppt_path)
    print(f"PPT saved: {ppt_path}")

# Step 5: GUI to get manager name
root = tk.Tk()
root.withdraw()  # hide main window
manager_name = simpledialog.askstring("Org Chart Builder", "Enter Level 4 Manager Name:")

if manager_name:
    try:
        manager_id = df.loc[df["Employee Name"] == manager_name, "Employee ID"].iloc[0]
        traverse_level5(manager_id, manager_name)
        out_df = pd.DataFrame(output_rows, columns=["Level 4 Manager","Level 5 Employee","Level 6 Employee","Count of Direct Reports"])
        out_df.to_excel("OrgChart_Flat.xlsx", index=False)

        lines = export_indented_to_excel(out_df, "OrgChart_Indented.xlsx", manager_name)
        write_indented_to_ppt(lines, f"OrgChart_{manager_name.replace(' ','_')}.pptx")
    except IndexError:
        print(f"Manager '{manager_name}' not found in data.")
