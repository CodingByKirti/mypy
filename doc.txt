Sub UpdateFilteredFiles()
    Dim wb As Workbook
    Dim wsData As Worksheet, wsOptions As Worksheet
    Dim folderPath As String, filePath As String
    Dim fso As Object, file As Object
    Dim L3Name As String
    Dim lastRow As Long, rowNum As Long
    Dim wsOptionsLastRow As Long
    Dim L4List As Object
    Dim rng As Range, cell As Range
    Dim i As Integer
    
    ' Disable updates for better performance
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    ' Set folder path
    folderPath = ThisWorkbook.Path & "\Filtered_Files\"

    ' Create File System Object
    Set fso = CreateObject("Scripting.FileSystemObject")

    ' Ensure folder exists
    If Not fso.FolderExists(folderPath) Then
        MsgBox "Filtered_Files folder not found!", vbExclamation, "Error"
        Exit Sub
    End If

    ' Loop through each file in the folder
    For Each file In fso.GetFolder(folderPath).Files
        If LCase(Right(file.Name, 5)) = ".xlsx" Then
            ' Open the workbook
            Set wb = Workbooks.Open(file.Path)
            L3Name = Replace(file.Name, ".xlsx", "") ' Store L3 name (filename without extension)

            ' Set worksheet references
            On Error Resume Next
            Set wsData = wb.Sheets("Data")
            Set wsOptions = wb.Sheets("Options")
            On Error GoTo 0

            ' Skip if any sheet is missing
            If wsData Is Nothing Or wsOptions Is Nothing Then
                MsgBox "Missing required sheets in: " & wb.Name, vbExclamation, "Skipping"
                wb.Close False
                GoTo NextFile
            End If

            ' ---- FILTER "DATA" SHEET ----
            lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row

            ' Delete rows where Column A (Business Framework Group) does not match L3Name
            For rowNum = lastRow To 2 Step -1
                If wsData.Cells(rowNum, 1).Value <> L3Name Then
                    wsData.Rows(rowNum).Delete
                End If
            Next rowNum

            ' ---- GET L4 VALUES FROM OPTIONS SHEET ----
            Set L4List = CreateObject("Scripting.Dictionary") ' Store unique L4 values

            wsOptionsLastRow = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row
            Set rng = wsOptions.Range("D2:D" & wsOptionsLastRow)

            For Each cell In rng
                If cell.Value = L3Name Then
                    If Not L4List.exists(cell.Offset(0, 1).Value) Then
                        L4List.Add cell.Offset(0, 1).Value, Nothing
                    End If
                End If
            Next cell

            ' ---- UPDATE "OPTIONS" SHEET ----
            ' Update Col A
            wsOptions.Range("A2").Value = L3Name
            wsOptions.Range("A3:A" & wsOptions.Rows.Count).ClearContents ' Delete remaining Col A values

            ' Update Col B (Drop-down values)
            wsOptions.Range("B3:B" & wsOptions.Rows.Count).ClearContents ' Clear previous L4 values
            wsOptions.Range("B2").Value = "*" ' Keep * at B2
            i = 3 ' Start filling L4 values from B3

            For Each key In L4List.keys
                wsOptions.Cells(i, 2).Value = key
                i = i + 1
            Next key

            ' Save & close
            wb.Save
            wb.Close False

NextFile:
        End If
    Next file

    ' Restore application settings
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True

    ' Cleanup
    Set fso = Nothing

    MsgBox "Processing completed!", vbInformation, "Done"

End Sub
