Sub UpdateOptionsSheetForFilteredFiles()
    Dim wsOptions As Worksheet, wsL3 As Worksheet, wsL4 As Worksheet
    Dim lastRowOptions As Long, cell As Range
    Dim L3Name As String, L4Dict As Object
    Dim lastRowL4 As Long, newRow As Long

    ' Disable alerts and screen updating
    Application.DisplayAlerts = False
    Application.ScreenUpdating = False

    ' Set references to sheets
    Set wsOptions = ThisWorkbook.Sheets("Options")
    Set wsL3 = ThisWorkbook.Sheets("L3 Summary")
    Set wsL4 = ThisWorkbook.Sheets("L4 Summary")

    ' Get L3 name from the file name
    L3Name = Replace(ThisWorkbook.Name, ".xlsx", "")

    ' Clear existing data in Options Sheet (except headers)
    wsOptions.Range("A2:B" & wsOptions.Rows.Count).ClearContents

    ' Initialize dictionary to store unique L4s
    Set L4Dict = CreateObject("Scripting.Dictionary")

    ' Find all L4 values under the current L3 in the original Options sheet
    lastRowOptions = wsOptions.Cells(wsOptions.Rows.Count, "D").End(xlUp).Row
    newRow = 2 ' Start writing from row 2

    For Each cell In wsOptions.Range("D2:D" & lastRowOptions)
        If cell.Value = L3Name Then
            ' Add L3 to Column A
            wsOptions.Cells(newRow, 1).Value = L3Name

            ' Add L4 to Column B (only if unique)
            If Not L4Dict.Exists(wsOptions.Cells(cell.Row, "E").Value) Then
                L4Dict.Add wsOptions.Cells(cell.Row, "E").Value, Nothing
                wsOptions.Cells(newRow, 2).Value = wsOptions.Cells(cell.Row, "E").Value
                newRow = newRow + 1
            End If
        End If
    Next cell

    ' Set L3 Summary B1 to L3 name (dropdown auto-updates)
    wsL3.Range("B1").Value = L3Name

    ' Set L4 Summary B1 to first available L4 or *
    If newRow > 2 Then
        wsL4.Range("B1").Value = "*"
    Else
        wsL4.Range("B1").Value = "No L4 Found"
    End If

    ' Re-enable alerts and screen updating
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True

    MsgBox "Options Sheet updated! Dropdowns will now show correct values.", vbInformation, "Done"
End Sub
