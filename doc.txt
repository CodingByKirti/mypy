Sub ProcessFilteredFiles_Simple()
    Dim wb As Workbook
    Dim wsData As Worksheet, wsOptions As Worksheet
    Dim wsL3Summary As Worksheet, wsL4Summary As Worksheet
    Dim folderPath As String, filePath As String
    Dim fso As Object, file As Object
    Dim L3Name As String
    Dim lastRow As Long, rowNum As Long

    ' Disable updates for better performance
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    ' Set folder path
    folderPath = ThisWorkbook.Path & "\Filtered_Files\"

    ' Create File System Object
    Set fso = CreateObject("Scripting.FileSystemObject")

    ' Ensure folder exists
    If Not fso.FolderExists(folderPath) Then
        MsgBox "Filtered_Files folder not found!", vbExclamation, "Error"
        Exit Sub
    End If

    ' Loop through each file in the folder
    For Each file In fso.GetFolder(folderPath).Files
        If LCase(Right(file.Name, 5)) = ".xlsx" Then
            ' Open the workbook
            Set wb = Workbooks.Open(file.Path)
            L3Name = Replace(wb.Name, ".xlsx", "")

            ' Set worksheet references
            On Error Resume Next
            Set wsData = wb.Sheets("Data")
            Set wsOptions = wb.Sheets("Options")
            Set wsL3Summary = wb.Sheets("L3 Summary")
            Set wsL4Summary = wb.Sheets("L4 Summary")
            On Error GoTo 0

            ' Skip if any sheet is missing
            If wsData Is Nothing Or wsOptions Is Nothing Or wsL3Summary Is Nothing Or wsL4Summary Is Nothing Then
                MsgBox "Missing required sheets in: " & wb.Name, vbExclamation, "Skipping"
                wb.Close False
                GoTo NextFile
            End If

            ' ---- FILTER "DATA" SHEET ----
            lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row

            ' Delete rows where Col A does not match file name (L3Name)
            For rowNum = lastRow To 2 Step -1
                If wsData.Cells(rowNum, 1).Value <> L3Name Then
                    wsData.Rows(rowNum).Delete
                End If
            Next rowNum

            ' ---- UPDATE "L3 Summary" & "L4 Summary" ----
            wsL3Summary.Range("B1").Value = L3Name
            wsL4Summary.Range("B1").Value = L3Name

            ' Save & close
            wb.Save
            wb.Close False

NextFile:
        End If
    Next file

    ' Restore application settings
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True

    ' Cleanup
    Set fso = Nothing

    MsgBox "Processing completed!", vbInformation, "Done"

End Sub
